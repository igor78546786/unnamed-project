{% extends 'calculadora/base.html' %}

{% block body_id %}id="page-sistemas-lineares"{% endblock %}

{% block title %}Sistemas Lineares{% endblock %}

{% block content %}
    <header class="tool-header">
        <i class="tool-icon fa-solid fa-border-all"></i>
        <h1>Resolver Sistemas Lineares</h1>
        <p>Insira a matriz de coeficientes (A) e o vetor de constantes (b) para resolver Ax = b.</p>
    </header>

    <div class="form-panel">
        <form method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <label>Tamanho do Sistema (M equações, N variáveis)</label>
                <div class="input-group-columns">
                    <input type="number" id="matrix-rows" name="matrix_rows" min="2" max="10" value="3" class="form-control" title="Número de Equações (Linhas)">
                    <span>x</span>
                    <input type="number" id="matrix-cols" name="matrix_cols" min="2" max="10" value="3" class="form-control" title="Número de Variáveis (Colunas)">
                    <button type="button" id="generate-matrix-btn" class="cta-button-secondary">Gerar Matriz</button>
                </div>
            </div>

            <div class="form-group">
                <label>Matriz Aumentada [A|b]</label>
                <div id="matrix-grid-container" class="matrix-grid">
                    </div>
            </div>

            <div class="form-group">
                <label for="metodo_sistema">Método de Resolução</label>
                <select id="metodo_sistema" name="metodo" required>
                    <option value="gauss">Eliminação de Gauss</option>
                    <option value="gauss_jordan">Gauss-Jordan</option>
                    <option value="jacobi" disabled>Método de Jacobi (em breve)</option>
                </select>
            </div>

            <button type="submit" class="cta-button">Resolver Sistema</button>
        </form>
    </div>

    {% if erro %}
    <div class="erro-card">
        <h2>Erro no Cálculo</h2>
        <p>{{ erro }}</p>
    </div>
    {% endif %}

    {% if solucao %}
    <section class="results-section">
        
        <div class="result-card">
            <h2>Solução Encontrada (Vetor x)</h2>
            <div class="solution-vector">
                {% for val in solucao %}
                    <p>x<sub>{{ forloop.counter }}</sub> ≈ {{ val }}</p>
                {% endfor %}
            </div>
        </div>

        <div class="step-by-step">
            <h3>Detalhes da Eliminação (Passo a Passo)</h3>
            
            {% for passo in iteracoes %}
                <div class="matrix-step">
                    <h4>{{ passo.passo }}</h4>
                    <table class="matrix-table">
                        <tbody>
                            {% for linha in passo.matriz %}
                            <tr>
                                {% for valor in linha %}
                                <td>{{ valor|floatformat:4 }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <script>
        const rowsInput = document.getElementById('matrix-rows');
        const colsInput = document.getElementById('matrix-cols');
        const generateBtn = document.getElementById('generate-matrix-btn');
        const gridContainer = document.getElementById('matrix-grid-container');

        function generateMatrix() {
            const M = parseInt(rowsInput.value); 
            const N = parseInt(colsInput.value); 

            if (M < 2 || M > 10 || N < 2 || N > 10) {
                alert("Por favor, insira um tamanho entre 2 e 10 para linhas e colunas.");
                return;
            }

            gridContainer.innerHTML = '';
            gridContainer.style.gridTemplateColumns = `repeat(${N}, 1fr) auto 1fr`;

            for (let i = 0; i < M; i++) {
                for (let j = 0; j < N; j++) {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.name = `a_${i}_${j}`;
                    input.placeholder = `a${i+1}${j+1}`;
                    input.required = true;
                    gridContainer.appendChild(input);
                }

                const separator = document.createElement('div');
                separator.className = 'matrix-separator';
                gridContainer.appendChild(separator);

                const inputB = document.createElement('input');
                inputB.type = 'number';
                inputB.step = 'any';
                inputB.name = `b_${i}`;
                inputB.placeholder = `b${i+1}`;
                inputB.required = true;
                gridContainer.appendChild(inputB);
            }
        }

        generateMatrix();
        generateBtn.addEventListener('click', generateMatrix);
    </script>
{% endblock %}