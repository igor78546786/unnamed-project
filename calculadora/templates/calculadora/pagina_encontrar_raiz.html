{% extends 'calculadora/base.html' %}

{% block body_id %}id="page-encontrar-raiz"{% endblock %}

{% block title %}Encontrar Raíz {% endblock %}

{% block content %}
    <header class="tool-header">
        <i class="tool-icon fa-solid fa-chart-line"></i>
        <h1>Encontrar Raíz de uma Equação</h1>
        <p>Insira os dados para encontrar a solução de f(x) = 0.</p>
    </header>

    <div class="form-panel">
        <form method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="funcao">Função f(x)</label>
                <input type="text" id="funcao" name="funcao_texto" placeholder="Ex: x**3 - 2*x + 1" required>
            </div>
            
            <div class="form-group">
                <label for="metodo">Método de Cálculo</label>
                <select id="seletor-metodo" name="metodo" required>
                    <option value="bissecao" selected>Método da Bisseção</option>
                    <option value="falsa_posicao">Método da Falsa Posição</option>
                    <option value="newton">Método de Newton-Raphson</option>
                </select>
            </div>

            <div class="form-group" id="grupo-intervalo">
                <label>Intervalo [a, b]</label>
                <div class="input-group">
                    <input type="number" step="any" name="intervalo_a" placeholder="a">
                    <input type="number" step="any" name="intervalo_b" placeholder="b">
                </div>
            </div>

            <div class="form-group hidden" id="grupo-estimativa">
                <label for="estimativa">Estimativa Inicial (x0)</label>
                <input type="number" step="any" id="estimativa" name="estimativa_inicial" placeholder="Ex: 1.5">
            </div>

            <button type="submit" class="cta-button">Calcular Raíz</button>
        </form>
    </div>

    {% if erro %}
    <div class="erro-card">
        <h2>Erro no Cálculo</h2>
        <p>{{ erro }}</p>
    </div>
    {% endif %}

    {% if resultado %}
    <section class="results-section">
        
        <div class="result-card">
            <h2>Resultado Encontrado</h2>
            <p class="result-value">x ≈ {{ resultado }}</p>
            <p class="result-meta">Calculado com o <strong>{{ metodo_utilizado }}</strong> em {{ iteracoes|length }} iterações.</p>
        </div>

        {% if metodo_utilizado == "Bissecao" or metodo_utilizado == "Falsa Posicao" %}
        <div class="step-by-step root-table-container">
            <h3>Detalhes da Convergência (Passo a Passo)</h3>
            <table class="root-table">
                <thead>
                    <tr>
                        <th>Iteração</th>
                        <th>a</th>
                        <th>b</th>
                        <th>Ponto Médio (p)</th>
                        <th>f(p)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for passo in iteracoes %}
                    <tr>
                        <td>{{ passo.n }}</td>
                        <td>{{ passo.a|floatformat:5 }}</td>
                        <td>{{ passo.b|floatformat:5 }}</td>
                        <td>{{ passo.p|floatformat:5 }}</td>
                        <td>{{ passo.f_p|floatformat:5 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% elif metodo_utilizado == "Newton" %}
        <div class="step-by-step root-table-container">
            <h3>Detalhes da Convergência (Passo a Passo)</h3>
            <table class="root-table">
                <thead>
                    <tr>
                        <th>Iteração (i)</th>
                        <th>xi</th>
                        <th>f(xi)</th>
                        <th>f'(xi)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for passo in iteracoes %}
                    <tr>
                        <td>{{ passo.n }}</td>
                        <td>{{ passo.xi|floatformat:5 }}</td>
                        <td>{{ passo.f_xi|floatformat:5 }}</td>
                        <td>{{ passo.df_xi|floatformat:5 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

    </section>
    {% endif %}

    <script>
        const seletorMetodo = document.getElementById('seletor-metodo');
        const grupoIntervalo = document.getElementById('grupo-intervalo');
        const grupoEstimativa = document.getElementById('grupo-estimativa');

        function atualizarCampos() {
            if (seletorMetodo.value === 'newton') {
                grupoIntervalo.classList.add('hidden');
                grupoEstimativa.classList.remove('hidden');
            } else {
                grupoIntervalo.classList.remove('hidden');
                grupoEstimativa.classList.add('hidden');
            }
        }
        seletorMetodo.addEventListener('change', atualizarCampos);
        atualizarCampos();
    </script>
{% endblock %}